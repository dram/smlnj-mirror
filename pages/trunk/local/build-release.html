<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>Building a Release</title>
    <style type="text/css">
      ol a {list-style-type: lower-alpha;}
      ol > li {margin-bottom: 0.5em;}
    </style>
  </head>

  <body>
    <h1>Building a Release</h1>
    <p>
    In the discussion below, we use <tt><i>$VERSION</i></tt> to represent the release version in
    question (<i>e.g.</i>, <tt>110.79</tt>), <tt><i>$ARCH</i></tt> to represent the host
    architecture (<i>e.g.</i>, <tt>x86</tt>), and <tt><i>$OS</i></tt> to represent the host
    operating system.
    </p>
    <p>
    The main steps in building a release are as follows:
    </p>
    <ul>
      <li>
      Create the directory to contain the release.  E.g. in a working copy
      of the pages project, <tt>svn add directory dist/working/<i>$VERSION</i></tt>, where n is
      the release number. Then commit the change, and update the web-site
      copy of the pages project at <tt>/stages/web_static/smlnj/htdocs</tt>.
      </li>
      <li>
      Write the <tt><i>$VERSION</i>-README.html</tt> file and commit it.
      Also update the HISTORY file.
      </li>
      <li>
      Run the allcross script in base/system to build boot directories for 
      all the architectures and create tarballs from them.
      Copy these tarballs to the <tt>dist/working/<i>$VERSION</i></tt> directory created in the first step.
      </li>
      <li>
      Export source directories and create tarballs and transfer them to
      the distribution directory.
      </li>
      <li>
      Create .dmg file for Mac OS X installation, and a Windows .zip file.
      (Details?). Add these to the distribution directory.
      </li>
      <li>
      Add a link to </tt>dist/working/<i>$VERSION</i>/<i>$VERSION</i>-README.html</tt> to
      <tt>dist/index.html</tt>.
      </li>
    </ul>

<p>
Following are specific instructions for building a SML/NJ release,
divided by operating system (Linux, OS X, Windows).
</p>

<h2>Building on UNIX</h2>
<ol>
  <li>
    <p>
    Update current copy, or check out a fresh copy:
    </p>
    <ul>
      <li> <tt>$ ./admin/refresh-all.sh</tt></li>
      <li> Or from a CS machine: <tt>svn co --username <i>yourusernamehere</i>
        <a href="https://smlnj-gforge/svn/smlnj/admin" class="external free" title="https://smlnj-gforge/svn/smlnj/admin" rel="nofollow">https://smlnj-gforge/svn/smlnj/admin</a></tt>,
        then <tt>$ ./admin/checkout-all.sh</tt>.
      </li>
    </ul>
  </li>
  <li>
    <p>
    Compile to fixed point:
    </p>
    <ul>
      <li> <tt>$ cd base/system</tt></li>
      <li> <tt>$ ./fixpt</tt></li>
    </ul>
    <p>
      This script will produce two directories: <tt>sml.boot.<i>$ARCH-$OS</i></tt>
      and <tt>sml.bin.<i>$ARCH-$OS</i></tt>.
    </p>
    <p>
      <b>Note:</b> prior to 110.79, the <tt>fixpt</tt> script left the result in directories
      that were indexed by iteration (<i>e.g.</i>, <tt>sml2.bin.x86-unix</tt>).
      Use the "<tt>-save</tt>" option to the <tt>fixpt</tt> command to force the old
      behavior.
    </p>
  </li>
<!--  No longer needed; the fixpt script does this step now [2015-10-04]
  <li>
    Take the <tt>.bin</tt> and <tt>.boot</tt> files and make them the official ones.
    <ul>
      <li>
        This depends on how many iterations it took to reach a fixed point.
        For example, if <tt>fixpt</tt> took two iterations on a x86 UNIX platform (the postfix
        notation follows a <i>$ARCH-$OS</i> convention), then you would do the following:
        <ul>
	  <li> <tt>$ rm -rf sml.bin.* sml.boot.*</tt></li>
	  <li> <tt>$ mv sml2.bin.x86-unix sml.bin.x86-unix</tt></li>
	  <li> <tt>$ mv sml2.boot.x86-unix sml.boot.x86-unix</tt></li>
	</ul>
      </li>
    </ul>
  </li>
-->
  <li>
    <p>
    Generate new library and heap files.
    </p>
    <ul>
      <li> <tt>$ ./makeml</tt></li>
    </ul>
  </li>
  <li>
    <p>
    Test the build.
    </p>
    <ul>
      <li> <tt>$ ./testml</tt></li>
    </ul>
  </li>
  <li>
    <p>
    Install the new code (the "<tt>-clean</tt> flag removes the old libraies and heap images).
    </p>
    <ul>
      <li> <tt>$ ./installml -clean</tt></li>
      <li> (To check everything &mdash; make sure everything is enabled in <tt>config/targets</tt>.)</li>
    </ul>
  </li>
  <li>
    <p>
    Build a working installation.
    </p>
    <ul>
      <li> <tt>$ cd ../..</tt></li>
      <li> <tt>$ ./config/install.sh</tt></li>
    </ul>
  </li>
  <li>
    <p>
    Update the <tt>version</tt> and <tt>releasedate</tt> files in the <tt>config</tt> directory.
    </p>
    <ul>
      <li> <tt>$ cd config</tt></li>
      <li> <tt>$ echo <i>$VERSION</i> &gt; ./config/version</tt></li>
      <li> <tt>$ echo <i>$DATE</i> &gt; ./config/releasedate</tt></li>
      <li> <tt>$ svn commit -m "updating version number to <i>$VERSION</i></tt></li>
      <li> <tt>$ cd ..</tt></li>
    </ul>
  </li>
  <li>
    <p>
    Build to another fixed point in <tt>base/system</tt>.
    </p>
    <ul>
      <li> <tt>$ cd base/system</tt></li>
      <li> <tt>$ ./fixpt</tt></li>
    </ul>
  </li>
  <li>
    <p>
    Repeat steps 2 through 6 above.
    </p>
    <ul>
      <li> Can omit step involving <tt>testml</tt>.  (<i>Which seems broken in my notes anyway.</i>)</li>
    </ul>
  </li>
  <li>
    <p>
    Cross compile and generate tarballs for the bin files:
    </p>
    <ul>
      <li> <tt>$ cd base/system</tt></li>
      <li> <tt>$ ./allcross</tt></li>
    </ul>
    <p>
    The <tt>allcross</tt> script will cross compile for all targets and produce gzipped tar files
    (<i>e.g.</i>, <tt>boot.x86-uniz.tgz</tt>).
    </p>
  </li>
  <li>
    <p>
    Edit/update the history file.
    </p>
    <ul>
      <li> <tt>../doc/src/changelog/HISTORY.txt</tt>: Add a new version section header.</li>
      <li>
        <tt>../doc/src/releasenotes/</tt>: Copy previous version's README and edit; older
        versions give examples of format expectations.
        <ul>
          <li> Cut and paste relevant entries from <tt>HISTORY.txt</tt> and format them.</li>
          <li>
	    Also check the SML/NJ Library's change log (<tt>smlnj-lib/CHANGES</tt>), since
	    those changes often do not make it into the <tt>HISTORY</tt> file.
          </li>
	</ul>
      </li>
    </ul>
  </li>
  <li>
    <p>
    Update web pages.
    </p>
    <ul>
      <li>
        Go to the relevant SML/NJ web server directory.
        <ul>
          <li>
            On the UChicago CS cluster at: <tt>/stage/web_static/smlnj/htdocs/dist/working</tt>.
            Ideally this all under Subversion control, but this convention isn't being
	    followed 100%.
          </li>
        </ul>
      </li>
      <li> Add a directory for <tt><i>$VERSION</i></tt>.</li>
      <li> Copy previous index file over and update links.</li>
<!-- this step is now hndled by the allcross script
      <li>
        Build tarballs:
        <ul>
          <li> <tt>$ for i in alpha32-unix ...; do f=sml.boot.$i; t=boot.$i.tgz; tar cfz $t $f/*; done</tt></li>
        </ul>
      </li>
-->
      <li>
	Copy the <tt>boot</tt> tarballs and <tt><i>$VERSION</i>-README.html</tt> file
        into the release directory.
      </li>
    </ul>
  </li>
  <li>
    <p>
    Tag the release.
    </p>
    <ul>
      <li>
        <tt>$ ./admin/make-release.sh</tt><br/>
	Note that each major directory under smlnj has its own trunk and
	release branches, <i>e.g.</i>, <tt>$smlnj/sml/trunk</tt>,
	<tt>$smlnj/sml/releases/release-<i>$VERSION</i></tt>, except for <tt>ml-lpt</tt>,
	which does not have release branches.
      </li>
    </ul>
  </li>
  <li>
    <p>
    Create source tarballs:
    </p>
    <ul>
      <li> <tt>$ mkdir tmp</tt></li>
      <li> <tt>$ cd tmp</tt></li>
      <li> <tt>$ svn export https://smlnj-gforge.cs.uchicago.edu/svn/smlnj/admin</tt></li>
      <li> <tt>$ ./admin/build-tar-files.sh</tt></li>
    </ul>
  </li>
  <!-- the doc.tgz file is not created by the build-tar-files.sh script [2014-12-21]
  <li>
    <p>
    Create the documentation tarball (note that the previous step will have exported
    a copy of the documentation source, but will not have created a tarball for it).
    </p>
    <p>
    The first step is to generate the documentation:
    </p>
    <ul>
      <li> <tt>$ cd doc</tt>
      <li> <tt>$ autoconf -Iconfig</tt>
      <li> <tt>$ configure</tt>
      <li> <tt>$ make man</tt>
    </ul>
    <p>
    The second step is to create the tarball.
    </p>
    <ul>
      <li> <tt>$ tar -zcf ../doc.tgz doc</tt>
    </ul>
  </li>
  -->
  <li>
    <p>
    Copy tarballs into the release directory.
    </p>
    <ul>
      <li> <tt>$ scp *.tgz linux.cs.uchicago.edu:/stage/web_static/smlnj/htdocs/dist/working/<i>$VERSION</i></tt>
    </ul>
  </li>
  <li>
    Create DMG files for Mac <a href="#dmg-files"><i>(See below)</i>.</a>
  </li>
  <li>
    Create MSI files for Windows <a href="#msi-files"><i>(See below)</i>.</a>
  </li>
  <li>
    Sanity checks:
    <ul>
      <li> Download, install, and run tests.</li>
    </ul>
  </li>
  <li>
    Update links:
    <ul>
      <li> Symbolic link at <tt>/stage/web_static/smlnj/htdocs/dist/working/current</tt></li>
      <li> Table at <tt>/stage/web_static/smlnj/htdocs/dist/working/index.html</tt></li>
      <li> What's new and links in <tt>/stage/web_static/smlnj/htdocs/index.html</tt></li>
    </ul>
  </li>
</ol>

<a name="dmg-files"><h2>Building a OS X package and dmg</h2></a>
<p> See the document <a href="osx-package-build.txt">osx-package-build.txt</a>.

<!--
<ul><li> Example: <tt>admin/checkout-all.sh --export</tt> from some directory named after the new version.
</li></ul>
</li><li> Enable building all targets.
<ol><li> <tt>$ cp config/targets config/targets.customized</tt>
</li><li> <tt> $ vi config/targets.customized</tt>
</li></ol>
</li>
<li> Note that if you are building on Snow Leopard, then you have to modify the makefile
to guarantee that the runtime will work on Leopard.
The following linker flags are needed when linking the various static libraries that make up
the runtime system:
<blockquote><tt>
-isysroot /Developer/SDKs/MacOSX10.5.sdk -mmacosx-version-min=10.5
</tt></blockquote>
</li>

<li> Build the exported copy and remove the boot file.
<ol><li> Plain-old "<tt>$ config/install.sh</tt>"
</li><li> <tt>$ rm boot.x86-unix.tgz</tt>
</li></ol>
</li><li> Create or modify a PackageMaker package.
<ul><li> Example: <tt>smlnj-110.68.pmdoc</tt>

<ul><li> I'm currently keeping this in <tt>~/ML</tt> on the iMac.
</li></ul>
</li><li> The background image can be found inside earlier distributions.
</li></ul>
</li><li> Build and test the <tt>.mpkg</tt> file.
</li><li> Create the DMG file using Disk Utility application.
<ul><li> Specifically, use the "File &gt; New &gt; Disk Image from Folder" command. 

</li></ul>
</li><li> Test the DMG file.
</li><li> Post online.
</li><li> Redo it all again, but remotely on a PPC system (currently advised to use <tt>g5.cs.uchicago.edu</tt>. -<em>Note: As of 6/29/2010, I (jriehl) am unable to access g5.  I advise checking with <a href="mailto:techstaff@cs.uchicago.edu">techstaff</a>.</em>)
<ul><li> Somewhere in there, there is a "move the built source tree to your desktop" step.
</li></ul>
</li></ol>
<p>References: Apple's "Software Delivery Guide" (should be available from ADC, or inside of Xcode).
</p>
-->

<a name="msi-files"><h2>Building a Windows installer (MSI)</h2></a>

<p>Steps preceded by [cygwin] are performed in the cygwin shell.<br>
Steps preceded by [vc++] are performed in the Visual C++ command
prompt.
</p>

<ol>
<li> Install cygwin (32-bit version)
<ul>
   <li>URL: <tt>http://www.cygwin.com</tt></li>
   <li>package selection should include:
     <ul>
       <li>wget or curl</li>
       <li>binutils</li>
       <li>svn (included in default install in cygwin 1.7)</li>
     </ul>
</ul>
</li><br>

<li>Install Visual C++ Express (or VisualStudio)
<ul>
   <li>URL: <tt>http://msdn.microsoft.com/vstudio</tt></li>
   <li>search for Visual C++ Express to find download page</li>
</ul>
</li><br>

<li>[cygwin] create a directory to build a release. This directory path
   must not contain a number.<br>
   (in my case: <tt>/home/jhr/Work/smlnj/release</tt> or <tt>c:\cygwin\home\jhr\Work\smlnj\release</tt>)
</li><br>

<li>[cygwin] in /home/jhr/Work/smlnj directory,
<ul class="a">
   <li><tt>$ mkdir gf</tt></li>
   <li><tt>$ export gf=https://smlnj-gforge.cs.uchicago.edu/svn</tt></li>
   <li><tt>$ export smlnj=$gf/smlnj</tt></li>
   <li><tt>$ export VERSION=xxx.yy</tt></li>
</ul>   
</li><br>

<li>[cygwin] <tt>$ cd gf; svn co $smlnj/admin</tt><br>
   Create gf/admin directory with the usual scripts.
</li><br>

<li>[cygwin] <tt>$ cd ../release</tt><br>
    Go to build directory.</li>
</li><br>

<li>[cygwin] <tt>$ ../gf/admin/checkout-all.sh -e</tt><br>
   Run checkout-all.sh script to export the source files.
</li><br>

<li>[cygwin] <tt>$ touch smlnj-lib/HTML4/*.l.sml smlnj-lib/HTML4/*.g.sml</tt><br>
   Ensure that the generated files look more recent than the parser/lexer
   specifications.
</li><br>

<li>[cygwin] <tt>$ curl -O http://www.smlnj.org/dist/working/<i>$VERSION</i>/boot.x86-win32.tgz</tt><br>
   Manually fetch to boot tarball for Windows.
</li><br>

<li>[cygwin] <tt>$ tar xzvf boot.x86-win32.tgz</tt><br>
   Manually untar the boot tarball.
</li><br>

<li>[vc++] <tt>set SMLNJ_HOME=C:\cygwin\home\jhr\Work\smlnj\release</tt><br>
    Define <tt>SMLNJ_HOME</tt> variable.
</li><br>

<li>[vc++] <tt>chdir %SMLNJ_HOME%</tt>
</li><br>

<li>[vc++] <tt>config\install.bat</tt><br>
</li><br>

<li>[vc++] <tt>config\WinSetup\buildSetup.bat</tt><br>
    The file <tt>smlnj.msi</tt> produced is the final installer for Windows.
</li>

<li>[cygwin] <tt>$ scp smlnj.msi linux.cs.uchicago.edu:/stage/web_static/smlnj/htdocs/dist/working/<i>$VERSION</i>/smlnj-<i>$VERSION</i>.msi</tt><br>
    Copy the MSI file to the distribution directory; we add a <tt><i>$VERSION</i></tt> tag so that folks can
    keep multiple downloads distinct.
</li>
</ol>

    <hr>
<!-- Created: Mon May  7 13:30:08 CDT 2007 -->
<!-- hhmts start -->Last modified: October 4, 2015 <!-- hhmts end -->
  </body>
</html>
