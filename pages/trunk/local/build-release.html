<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>Building a Release</title>
    <style type="text/css">
      ol a {list-style-type: lower-alpha;}
      ol > li {margin-bottom: 0.5em;}
    </style>
  </head>

  <body>
    <h1>Building a Release</h1>
The main steps in building a release are as follows:
<ul>
  <li>
  Create the directory to contain the release.  E.g. in a working copy
  of the pages project, svn add directory dist/working/110.n, where n is
  the release number. Then commit the change, and update the web-site
  copy of the pages project at <tt>/stages/web_static/smlnj/htdocs</tt>.
  </li>
  <li>
  Write 110.n-README.txt and 110.n-README.html files and commit them.
  Also update NOTES/HISTORY file.
  </li>
  <li>
  Run the allcross script in base/system to build boot directories for 
  all the architectures and create tarballs from them.
  Copy these tarballs to the <tt>dist/working/110.n</tt> directory created in the first step.
  </li>
  <li>
  Export source directories and create tarballs and transfer them to
  the distribution directory.
  </li>
  <li>
  Create .dmg file for Mac OS X installation, and a Windows .zip file.
  (Details?). Add these to the distribution directory.
  </li>
  <li>
  Add a link to dist/working/110.n/110.n-README.html to
  dist/index.html.
  </li>
</ul>

Following are specific instructions for building a SML/NJ release,
divided by operating system (Linux, OS X, Windows).

<h2>Building on UNIX</h2>
<ol>
  <li>
    Update current copy, or check out a fresh copy:
    <ul>
      <li> <tt>$ ./admin/refresh-all.sh</tt></li>
      <li> Or from a CS machine: <tt>svn co --username <i>yourusernamehere</i>
        <a href="https://smlnj-gforge/svn/smlnj/admin" class="external free" title="https://smlnj-gforge/svn/smlnj/admin" rel="nofollow">https://smlnj-gforge/svn/smlnj/admin</a></tt>,
        then <tt>./admin/checkout-all.sh</tt>.
      </li>
    </ul>
  </li>
  <li>
    Compile to fixed point:
    <ul>
      <li> <tt>$ cd base/system</tt></li>
      <li> <tt>$ ./fixpt</tt></li>
    </ul>
  </li>
  <li>
    Take the <tt>.bin</tt> and <tt>.boot</tt> files and make them the official ones.
    <ul>
      <li>
        This depends on how many iterations it took to reach a fixed point.
        For example, if <tt>fixpt</tt> took two iterations on a x86 UNIX platform (the postfix
        notation follows a <i>CPU-OS</i> convention), then you would do the following:
        <ul>
	  <li> <tt>$ rm -rf sml.bin.* sml.boot.*</tt></li>
	  <li> <tt>$ mv sml2.bin.x86-unix sml.bin.x86-unix</tt></li>
	  <li> <tt>$ mv sml2.boot.x86-unix sml.boot.x86-unix</tt></li>
	</ul>
      </li>
    </ul>
  </li>
  <li>
    Generate new library and heap files.
    <ul>
      <li> <tt>$ ./makeml</tt></li>
    </ul>
  </li>
  <li>
    Test the build.
    <ul>
      <li> <tt>$ ./testml</tt></li>
    </ul>
  </li>
  <li>
    Remove the old libraries.
    <ul>
      <li> <tt>$ rm -rf ../../lib/*</tt></li>
      <li> <tt>$ rm -rf ../../bin/.heap/*</tt></li>
      <li> <tt>$ ./installml</tt></li>
      <li> (To check everything &mdash; make sure everything is enabled in <tt>config/targets</tt>.)</li>
    </ul>
  </li>
  <li>
    Build a working installation.
    <ul>
      <li> <tt>$ cd ../..</tt></li>
      <li> <tt>$ ./config/install.sh</tt></li>
    </ul>
  </li>
  <li>
    Edit the version number.
    <ul>
      <li> <tt>$ $EDITOR ./config/version</tt></li>
    </ul>
  </li>
  <li>
    Build to another fixed point in <tt>base/system</tt>.
    <ul>
      <li> <tt>$ cd base/system</tt></li>
      <li> <tt>$ ./fixpt</tt></li>
    </ul>
  </li>
  <li>
    Repeat steps 3 through 7 above.
    <ul>
      <li> Can omit step involving <tt>testml</tt>.  (<i>Which seems broken in my notes anyway.</i>)</li>
    </ul>
  </li>
  <li>
    Cross compile and generate tarballs for the bin files:
    <ul>
      <li> <tt>$ cd base/system</tt></li>
      <li> <tt>$ ./allcross</tt></li>
    </ul>
    The <tt>allcross</tt> script will cross compile for all targets and produce gzipped tar files
    (<i>e.g.</i>, <tt>boot.x86-uniz.tgz</tt>).
  </li>
  <li>
    Edit/update the history file.
    <ul>
      <li> <tt>.../base/NOTES/HISTORY</tt>: Add a new log entry similar to others.</li>
      <li>
        <tt>.../base/READMES/</tt>: Copy previous version's README and edit; older
        versions give examples of format expectations.
        <ul>
          <li> Cut and paste relevant entries in <tt>HISTORY</tt> and format them.</li>
          <li>
	    Also check the SML/NJ Library's change log (<tt>smlnj-lib/CHANGES</tt>), since
	    those changes often do not make it into the <tt>HISTORY</tt> file.
          </li>
	</ul>
      </li>
    </ul>
  </li>
  <li>
    Update web pages.
    <ul>
      <li>
        Go to the relevant SML/NJ web server directory.
        <ul>
          <li>
            On the UChicago CS cluster at: <tt>/stage/web_static/smlnj/htdocs/dist/working</tt>.
            Ideally this all under Subversion control, but this convention isn't being
	    followed 100%.
          </li>
        </ul>
      </li>
      <li> Add directory for 110.XX.</li>
      <li> Copy previous index file over and update links.</li>
<!-- this step is now hndled by the allcross script
      <li>
        Build tarballs:
        <ul>
          <li> <tt>$ for i in alpha32-unix ...; do f=sml.boot.$i; t=boot.$i.tgz; tar cfz $t $f/*; done</tt></li>
        </ul>
      </li>
-->
      <li> Copy tarballs and README notes into the release directory.</li>
    </ul>
  </li>
  <li>
    Tag the release.
    <ul>
      <li>
        <tt>$ ./admin/make-release.sh</tt><br/>
	Note that each major directory under smlnj has its own trunk and
	release branches, <i>e.g.</i>, <tt>$smlnj/sml/trunk</tt>,
	<tt>$smlnj/sml/releases/release-110.74</tt>, except for <tt>ml-lpt</tt>,
	which does not have release branches.
      </li>
    </ul>
  </li>
  <li>
    Create source tarballs:
    <ul>
      <li> <tt>$ mkdir tmp</tt></li>
      <li> <tt>$ cd tmp</tt></li>
      <li> <tt>$ svn export https://smlnj-gforge.cs.uchicago.edu/svn/smlnj/admin</tt></li>
      <li> <tt>$ ./admin/build-tar-files.sh 110.XX</tt></li>
      <li> Copy tarballs into the release directory.</li>
    </ul>
    We use a temporary directory for this step to avoid including the <tt>.svn</tt> metadata.
  </li>
  <li>
    Create DMG files for Mac <a href="#dmg-files"><i>(See below)</i>.</a>
  </li>
  <li>
    Create MSI files for Windows <a href="#msi-files"><i>(See below)</i>.</a>
  </li>
  <li>
    Sanity checks:
    <ul>
      <li> Download, install, and run tests.</li>
    </ul>
  </li>
  <li>
    Update links:
    <ul>
      <li> Symbolic link at <tt>/stage/web_static/smlnj/htdocs/dist/working/current</tt></li>
      <li> Table at <tt>/stage/web_static/smlnj/htdocs/dist/working/index.html</tt></li>
      <li> What's new and links in <tt>/stage/web_static/smlnj/htdocs/index.html</tt></li>
    </ul>
  </li>
</ol>

<a name="dmg-files"><h2>Building a OS X package and dmg</h2></a>
<p> See the document <a href="osx-package-build.txt">osx-package-build.txt</a>.

<!--
<ul><li> Example: <tt>admin/checkout-all.sh --export</tt> from some directory named after the new version.
</li></ul>
</li><li> Enable building all targets.
<ol><li> <tt>$ cp config/targets config/targets.customized</tt>
</li><li> <tt> $ vi config/targets.customized</tt>
</li></ol>
</li>
<li> Note that if you are building on Snow Leopard, then you have to modify the makefile
to guarantee that the runtime will work on Leopard.
The following linker flags are needed when linking the various static libraries that make up
the runtime system:
<blockquote><tt>
-isysroot /Developer/SDKs/MacOSX10.5.sdk -mmacosx-version-min=10.5
</tt></blockquote>
</li>

<li> Build the exported copy and remove the boot file.
<ol><li> Plain-old "<tt>$ config/install.sh</tt>"
</li><li> <tt>$ rm boot.x86-unix.tgz</tt>
</li></ol>
</li><li> Create or modify a PackageMaker package.
<ul><li> Example: <tt>smlnj-110.68.pmdoc</tt>

<ul><li> I'm currently keeping this in <tt>~/ML</tt> on the iMac.
</li></ul>
</li><li> The background image can be found inside earlier distributions.
</li></ul>
</li><li> Build and test the <tt>.mpkg</tt> file.
</li><li> Create the DMG file using Disk Utility application.
<ul><li> Specifically, use the "File &gt; New &gt; Disk Image from Folder" command. 

</li></ul>
</li><li> Test the DMG file.
</li><li> Post online.
</li><li> Redo it all again, but remotely on a PPC system (currently advised to use <tt>g5.cs.uchicago.edu</tt>. -<em>Note: As of 6/29/2010, I (jriehl) am unable to access g5.  I advise checking with <a href="mailto:techstaff@cs.uchicago.edu">techstaff</a>.</em>)
<ul><li> Somewhere in there, there is a "move the built source tree to your desktop" step.
</li></ul>
</li></ol>
<p>References: Apple's "Software Delivery Guide" (should be available from ADC, or inside of Xcode).
</p>
-->

<a name="msi-files"><h2>Building a Windows installer (MSI)</h2></a>

<p>Steps preceded by [cygwin] are performed in the cygwin shell.<br>
Steps preceded by [vc++] are performed in the Visual C++ command
prompt.
</p>

<ol>
<li> Install cygwin
<ul>
   <li>URL: <tt>http://www.cygwin.com</tt></li>
   <li>package selection should include:
     <ul>
       <li>wget</li>
       <li>binutils</li>
       <li>svn  (included in default install in cygwin 1.7)</li>
     </ul>
</ul>
</li><br>

<li>Install Visual C++ Express
<ul>
   <li>URL: <tt>http://msdn.microsoft.com/vstudio</tt></li>
   <li>search for Visual C++ Express to find download page</li>
</ul>
</li><br>

<li>[cygwin] create a directory to build a release. This directory path
   must not contain a number.<br>
   (in my case: /home/dbm/smlnj/release or c:\cygwin\home\dbm\smlnj\release)
</li><br>

<li>[cygwin] in /home/dbm/smlnj directory,
<ol class="a">
   <li>create gf subdirectory</li>
   <li>create gf/abbrev shell script that defines $gf and $smlnj as
   usual</li>
</ol>   
</li><br>

<li>[cygwin] run fg/abbrev script, defining $gf and $smlnj</li><br>

<li>[cygwin] <tt>cd gf; svn co $smlnj/admin</tt><br>
   Create gf/admin directory with the usual scripts.
</li><br>

<li>[cygwin] <tt>cd ../smlnj/release</tt><br>
    Go to build directory.</li>
</li><br>

<li>[cygwin] <tt>../../gf/admin/checkout-all.sh</tt><br>
   Run checkout-all.sh script to check out the source files.
</li><br>

<li>[cygwin] <tt>wget http://www.smlnj.org/dist/working/110.74/boot.x86-win32.tgz</tt><br>
   Manually fetch to boot tarball for Windows.
</li><br>

<li>[cygwin] <tt>tar xzvf boot.x86-win32.tgz</tt><br>
   Manually untar the boot tarball.
</li><br>

<li>[vc++] go to <tt>C:\cygwin\home\dbm\smlnj\release</tt>
</li><br>

<li>[vc++] <tt>set SMLNJ_HOME=C:\cygwin\home\dbm\smlnj\release</tt><br>
    Define SMLNJ_HOME variable.
</li><br>

<li>[vc++] <tt>config\install.bat</tt><br>
</li><br>

<li>[vc++] <tt>config\WinSetup\buildSetup.bat</tt><br>
    The file <tt>smlnj.msi</tt> produced is the final installer for Windows.
</li>
</ol>

</blockquote>

    <hr>
    <address><a href="mailto:dbm@cs.uchicago.edu">David MacQueen</a>
and <a href="mailto:larsberg@cs.uchicago.edu">Lars Bergstrom</a>
and <a href="mailto:jriehl@spaceship.com">Jon Riehl</a></address>
<!-- Created: Mon May  7 13:30:08 CDT 2007 -->
<!-- hhmts start -->Last modified: Wed Feb  1 12:16:08 CST 2012 <!-- hhmts end -->
  </body>
</html>
