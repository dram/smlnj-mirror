%!PS
%%Version: 3.3
%%DocumentFonts: (atend)
%%Pages: (atend)
%%EndComments
%
% Version 3.3 prologue for troff files.
%

/#copies 1 store
/aspectratio 1 def
/formsperpage 1 def
/landscape false def
/linewidth .3 def
/magnification 1 def
/margin 0 def
/orientation 0 def
/resolution 720 def
/rotation 1 def
/xoffset 0 def
/yoffset 0 def

/roundpage true def
/useclippath true def
/pagebbox [0 0 612 792] def

/R  /Times-Roman def
/I  /Times-Italic def
/B  /Times-Bold def
/BI /Times-BoldItalic def
/H  /Helvetica def
/HI /Helvetica-Oblique def
/HB /Helvetica-Bold def
/HX /Helvetica-BoldOblique def
/CW /Courier def
/CO /Courier def
/CI /Courier-Oblique def
/CB /Courier-Bold def
/CX /Courier-BoldOblique def
/PA /Palatino-Roman def
/PI /Palatino-Italic def
/PB /Palatino-Bold def
/PX /Palatino-BoldItalic def
/Hr /Helvetica-Narrow def
/Hi /Helvetica-Narrow-Oblique def
/Hb /Helvetica-Narrow-Bold def
/Hx /Helvetica-Narrow-BoldOblique def
/KR /Bookman-Light def
/KI /Bookman-LightItalic def
/KB /Bookman-Demi def
/KX /Bookman-DemiItalic def
/AR /AvantGarde-Book def
/AI /AvantGarde-BookOblique def
/AB /AvantGarde-Demi def
/AX /AvantGarde-DemiOblique def
/NR /NewCenturySchlbk-Roman def
/NI /NewCenturySchlbk-Italic def
/NB /NewCenturySchlbk-Bold def
/NX /NewCenturySchlbk-BoldItalic def
/ZD /ZapfDingbats def
/ZI /ZapfChancery-MediumItalic def
/S  /S def
/S1 /S1 def
/GR /Symbol def

/inch {72 mul} bind def
/min {2 copy gt {exch} if pop} bind def

/setup {
	counttomark 2 idiv {def} repeat pop

	landscape {/orientation 90 orientation add def} if
	/scaling 72 resolution div def
	linewidth setlinewidth
	1 setlinecap

	pagedimensions
	xcenter ycenter translate
	orientation rotation mul rotate
	width 2 div neg height 2 div translate
	xoffset inch yoffset inch neg translate
	margin 2 div dup neg translate
	magnification dup aspectratio mul scale
	scaling scaling scale

	/Symbol /S Sdefs cf
	/Times-Roman /S1 S1defs cf
	0 0 moveto
} def

/pagedimensions {
	useclippath userdict /gotpagebbox known not and {
		/pagebbox [clippath pathbbox newpath] def
		roundpage currentdict /roundpagebbox known and {roundpagebbox} if
	} if
	pagebbox aload pop
	4 -1 roll exch 4 1 roll 4 copy
	landscape {4 2 roll} if
	sub /width exch def
	sub /height exch def
	add 2 div /xcenter exch def
	add 2 div /ycenter exch def
	userdict /gotpagebbox true put
} def

/pagesetup {
	/page exch def
	currentdict /pagedict known currentdict page known and {
		page load pagedict exch get cvx exec
	} if
} def

/decodingdefs [
	{counttomark 2 idiv {y moveto show} repeat}
	{neg /y exch def counttomark 2 idiv {y moveto show} repeat}
	{neg moveto {2 index stringwidth pop sub exch div 0 32 4 -1 roll widthshow} repeat}
	{neg moveto {spacewidth sub 0.0 32 4 -1 roll widthshow} repeat}
	{counttomark 2 idiv {y moveto show} repeat}
	{neg setfunnytext}
] def

/setdecoding {/t decodingdefs 3 -1 roll get bind def} bind def

/w {neg moveto show} bind def
/m {neg dup /y exch def moveto} bind def
/done {/lastpage where {pop lastpage} if} def

/f {
	dup /font exch def findfont exch
	dup /ptsize exch def scaling div dup /size exch def scalefont setfont
	linewidth ptsize mul scaling 10 mul div setlinewidth
	/spacewidth ( ) stringwidth pop def
} bind def

/changefont {
	/fontheight exch def
	/fontslant exch def
	currentfont [
		1 0
		fontheight ptsize div fontslant sin mul fontslant cos div
		fontheight ptsize div
		0 0
	] makefont setfont
} bind def

/sf {f} bind def

/cf {
	dup length 2 idiv
	/entries exch def
	/chtab exch def
	/newfont exch def

	findfont dup length 1 add dict
	/newdict exch def
	{1 index /FID ne {newdict 3 1 roll put} {pop pop} ifelse} forall

	newdict /Metrics entries dict put
	newdict /Metrics get
	begin
		chtab aload pop
		1 1 entries {pop def} for
		newfont newdict definefont pop
	end
} bind def

%
% A few arrays used to adjust reference points and character widths in some
% of the printer resident fonts. If square roots are too high try changing
% the lines describing /radical and /radicalex to,
%
%	/radical	[0 -75 550 0]
%	/radicalex	[-50 -75 500 0]
%
% Move braceleftbt a bit - default PostScript character is off a bit.
%

/Sdefs [
	/bracketlefttp		[201 500]
	/bracketleftbt		[201 500]
	/bracketrighttp		[-81 380]
	/bracketrightbt		[-83 380]
	/braceleftbt		[203 490]
	/bracketrightex		[220 -125 500 0]
	/radical		[0 0 550 0]
	/radicalex		[-50 0 500 0]
	/parenleftex		[-20 -170 0 0]
	/integral		[100 -50 500 0]
	/infinity		[10 -75 730 0]
] def

/S1defs [
	/underscore		[0 80 500 0]
	/endash			[7 90 650 0]
] def
%
% Tries to round clipping path dimensions, as stored in array pagebbox, so they
% match one of the known sizes in the papersizes array. Lower left coordinates
% are always set to 0.
%

/roundpagebbox {
    7 dict begin
	/papersizes [8.5 inch 11 inch 14 inch 17 inch] def

	/mappapersize {
		/val exch def
		/slop .5 inch def
		/diff slop def
		/j 0 def
		0 1 papersizes length 1 sub {
			/i exch def
			papersizes i get val sub abs
			dup diff le {/diff exch def /j i def} {pop} ifelse
		} for
		diff slop lt {papersizes j get} {val} ifelse
	} def

	pagebbox 0 0 put
	pagebbox 1 0 put
	pagebbox dup 2 get mappapersize 2 exch put
	pagebbox dup 3 get mappapersize 3 exch put
    end
} bind def

%%EndProlog
%%BeginSetup
mark
/resolution 720 def
setup
2 setdecoding
%%EndSetup
%%Page: 1 1
/saveobj save def
mark
1 pagesetup
10 R f
(-)720 840 w
12 B f
(Profiling in the Presence of Optimization and Garbage Collection)8 3353 1 1203 2400 t
10 I f
(Andrew W. Appel*)2 752 1 2504 2640 t
(Bruce F. Duba\262)2 646 1 2557 2760 t
(David B. MacQueen\262)2 867 1 2446 2880 t
(November 1988)1 635 1 2562 3432 t
(ABSTRACT)2643 4272 w
10 R f
( in tuning their performance, and programs)6 1782(Profiling the execution of programs can be a great help)9 2288 2 970 4428 t
( sta-)1 176( standard techniques of call-counting and)5 1684( The)1 213(written in functional languages are no exception.)6 1997 4 970 4548 t
( In)1 149( with some modification.)3 1048(tistical \(interrupt-driven\) execution time measurement work well, but)7 2873 3 970 4668 t
( profiler inserts)2 628( Our)1 214(particular, the program counter is not the best indicator of ``current function.'')11 3228 3 970 4788 t
(explicit increment and assignment statements into the intermediate representation, and is therefore)11 4070 1 970 4908 t
(very simple to implement and completely independent of the code-generator.)9 3078 1 970 5028 t
8 R f
( Incentive Grant.)2 536( Faculty)1 279(* Supported in part by NSF Grant CCR-8806121 and by a Digital Equipment Corp.)13 2671 3 720 5920 t
(\262 AT&T Bell Laboratories, Murray Hill, NJ.)6 1423 1 720 6056 t
cleartomark
showpage
saveobj restore
%%EndPage: 1 1
%%Page: 2 2
/saveobj save def
mark
2 pagesetup
10 R f
(- 2 -)2 166 1 2797 480 t
10 B f
( profiling)1 398(1. Execution)1 553 2 720 880 t
10 R f
( to be tuned for effi-)5 861(A large program usually consists of many small functions. When such a program is)13 3459 2 720 1076 t
( Then)1 259( those functions are taking the bulk of the execution time.)10 2340(ciency, it is necessary to identify which of)7 1721 3 720 1236 t
( a theoreti-)2 436( using)1 243( By)1 168(the commonly-used functions can be made more efficient, or called less often, or both.)13 3473 4 720 1396 t
( a complete theoreti-)3 835(cal analysis of the algorithms used in a program, such functions can be identified; but)14 3485 2 720 1556 t
(cal analysis is complex and impractical for large programs.)8 2359 1 720 1716 t
( widely-)1 342( A)1 134( measurement of the time spent in each function.)8 2040(An execution profiler provides an empirical)5 1804 4 720 2036 t
( tool,)1 214(used Unix)1 417 2 720 2196 t
10 B f
(prof)1384 2196 w
10 R f
([Unix], provides a count of how many times each function is called, and how many)14 3440 1 1600 2196 t
( information is very useful in identifying which functions are in)10 2582( This)1 257( in each function.)3 705(seconds were spent)2 776 4 720 2356 t
( after which a theoretical analysis of just those functions might be carried out, a much)15 3437(need of improvement,)2 883 2 720 2516 t
(less forbidding endeavor than analyzing the whole program.)7 2401 1 720 2676 t
10 B f
(Prof)720 2996 w
10 R f
( an)1 136(gathers call-count information by having the compiler insert at the beginning of each function)13 3955 2 949 2996 t
( approximation to the)3 906( An)1 188(instruction that increments a call-count variable associated with the function.)9 3226 3 720 3156 t
( 1/60th of a)3 494( every)1 283( is gathered by the use of a timer interrupt:)9 1808(amount of total time spent in the function)7 1735 4 720 3316 t
( is an)2 227( \(This)1 269( value of the program counter.)5 1248(second, the operating system notes in a ``histogram'' array the)9 2576 4 720 3476 t
( of program execution,)3 915( at the end)3 416( Then,)1 281(ancient technique [Johnston70].\))2 1308 4 720 3636 t
10 B f
(prof)3667 3636 w
10 R f
(estimates the amount of time)4 1163 1 3877 3636 t
( values in the histogram array corresponding to program counter)9 2687(spent in each function by summing the)6 1633 2 720 3796 t
( interrupt-driven sam-)2 892( The)1 213(samples between the beginning and end of the machine code for that function.)12 3215 3 720 3956 t
(pling method has a much lower overhead than querying a clock on each entry to and exit from a function.)19 4214 1 720 4116 t
(A more elaborate profiling tool,)4 1301 1 720 4436 t
10 B f
(gprof)2053 4436 w
10 R f
( When one primitive)3 848([Graham82], provides even more information.)4 1874 2 2318 4436 t
( it is useful to know, not only the total time for)11 1878(function \(e.g. a table-lookup routine\) is used in many places,)9 2442 2 720 4596 t
( ``charge'' the calling functions. With)5 1533(the execution of the primitive, but also, how much time to)10 2351 2 720 4756 t
10 B f
(gprof)4633 4756 w
10 R f
(this)4895 4756 w
( on that basis appor-)4 830(is approximated by keeping a count of the number of times each call-site is used, and)15 3490 2 720 4916 t
(tioning the average execution time of the called function to the functions that call it.)14 3354 1 720 5076 t
( problems for optimizing)3 1012(These approaches to execution-time measurement and apportionment pose certain)8 3308 2 720 5396 t
(compilers and for functional languages:)4 1586 1 720 5556 t
( function may be turned into)5 1195( A)1 134( for a function is not necessarily all contiguous.)8 1991( machine-code)1 595(1. The)1 405 5 720 5752 t
( problem could)2 605( This)1 228( interspersed.)1 532(several pieces of code, with portions of the code for other functions)11 2705 4 970 5912 t
( the optimizer and code generator, but we wanted to)9 2127(certainly be solved by elaborate bookkeeping in)6 1943 2 970 6072 t
(avoid that complexity.)2 897 1 970 6232 t
( program-counter method will)3 1258( The)1 224( optimizer can expand functions in-line in other functions.)8 2466(2. An)1 372 4 720 6428 t
( function, even though it might be desirable for in-line)9 2170(charge the calling function instead of the called)7 1900 2 970 6588 t
(expansion to be made semantically invisible.)5 1793 1 970 6748 t
( histogram array in)3 778(3. The)1 405 2 720 6944 t
10 B f
(prof)1935 6944 w
10 R f
( proportional in size to the address range spanned by pieces of)11 2569(must be)1 321 2 2150 6944 t
( data throughout memory;)3 1065( runtime system intersperses code and)5 1562( Our)1 214(code for executable functions.)3 1229 4 970 7104 t
( problem)1 359( This)1 229( code and data from place to place.)7 1397(even worse, it periodically garbage collects, moving)6 2085 4 970 7264 t
cleartomark
showpage
saveobj restore
%%EndPage: 2 2
%%Page: 3 3
/saveobj save def
mark
3 pagesetup
10 R f
(- 3 -)2 166 1 2797 480 t
( elaborate bookkeeping in the runtime system, which we also wanted to)11 2967(could have been solved by)4 1103 2 970 880 t
(avoid.)970 1040 w
( these problems in the course of implementing a profiler for an optimizing compiler for)14 3512(We had to deal with)4 808 2 720 1236 t
( approach we used is described in the next section.)9 2018( The)1 205(the functional language Standard ML [Appel87].)5 1952 3 720 1396 t
10 B f
( Representation of call-counting and current-function)5 2285(2. Intermediate)1 679 2 720 1716 t
10 R f
( estimation we use a timer interrupt, as does)8 1764(For execution-time)1 763 2 720 1912 t
10 B f
(prof)3273 1912 w
10 R f
( How-)1 278(, to increment a histogram entry.)5 1306 2 3456 1912 t
( we main-)2 403( Instead,)1 365( the program counter to calculate which histogram entry to increment.)10 2812(ever, we don't use)3 740 4 720 2072 t
( a global variable called)4 1041(tain a ``pointer-to-current-function-entry'' in)3 1855 2 720 2232 t
10 B f
(current)3663 2232 w
10 R f
(that is accessible to the)4 1009 1 4031 2232 t
( a call-count and an)4 821( function has associated with it two auxiliary variables:)8 2291( Each)1 260(timer-interrupt handler.)1 948 4 720 2392 t
( it increments the call-count and assigns the address of the)10 2604( entry to a function,)4 893(interrupt-count. On)1 823 3 720 2552 t
(interrupt-count variable into the global)4 1560 1 720 2712 t
10 B f
(current)2308 2712 w
10 R f
( when a timer interrupt occurs, the interrupt)7 1755(variable. Then,)1 628 2 2657 2712 t
(handler just increments the variable that)5 1600 1 720 2872 t
10 B f
(current)2345 2872 w
10 R f
(points to.)1 373 1 2691 2872 t
( returns \320 either normally or via an exception \320)9 2175(When a function)2 707 2 720 3192 t
10 B f
(current)3649 3192 w
10 R f
(must be set back to the)5 1023 1 4017 3192 t
( by the cal-)3 446( resetting could be done either)5 1211( This)1 229(interrupt-count variable of the function that it is returning to.)9 2434 4 720 3352 t
( several rea-)2 496( For)1 193(ling function \(after the called function has returned\), or by the called function before exit.)14 3631 3 720 3512 t
( stack of current-)3 720( a)1 108( the called function does the reset,)6 1445( If)1 130( calling function.)2 708(sons, it is better done by the)6 1209 6 720 3672 t
( stack of current-pointers would also greatly)6 1799( A)1 128( is required; this is expensive to maintain.)7 1708(function pointers)1 685 4 720 3832 t
( of exception-handlers; with the caller-reset method, the exception-handler justs)9 3305(complicate the treatment)2 1015 2 720 3992 t
(sets the)1 300 1 720 4152 t
10 B f
(current)1048 4152 w
10 R f
( recursive calls,)2 631( On)1 176( the appropriate counter variable on entry.)6 1700(to point at)2 412 4 1397 4152 t
10 B f
(current)4345 4152 w
10 R f
(need not)1 345 1 4695 4152 t
( but only the calling function knows which calls)8 1977(be reset \(as the calling and called function are the same\),)10 2343 2 720 4312 t
( finally, tail-calls can be optimized if the caller resets)9 2118( And)1 222(are recursive.)1 536 3 720 4472 t
10 B f
(current)3621 4472 w
10 R f
(.)3942 4472 w
( a tail-call,)2 436( After)1 266( is not followed by any executable code before the function returns.)11 2760(A tail-call is one that)4 858 4 720 4792 t
(the function will immediately return and therefore)6 2050 1 720 4952 t
10 B f
(current)2803 4952 w
10 R f
( it is not)3 347( Therefore,)1 474(will immediately be reset.)3 1062 3 3157 4952 t
( function to reset)3 698(necessary for the calling)3 993 2 720 5112 t
10 B f
(current)2444 5112 w
10 R f
( is a useful optimization, and it is)7 1384( This)1 236(after a tail-call.)2 622 3 2798 5112 t
(particularly important when used with a compiler that optimizes tail-calls into jumps; if the current pointer)15 4320 1 720 5272 t
( be reset after the tail-call, it would no longer be a tail-call and performance would suffer dramati-)17 4065(had to)1 255 2 720 5432 t
( it is easy to identify tail-calls statically as the profiling instructions are being inserted.)14 3450(cally. Fortunately,)1 755 2 720 5592 t
( In)1 134( statements in the intermediate representation.)5 1841(We insert the profiling instructions as ordinary assignment)7 2345 3 720 5912 t
( operations of fetching, adding)4 1243(almost any compiler's intermediate representation it is easy to represent the)10 3077 2 720 6072 t
( the)1 149(one, and storing, for the call-count increment operation; and storing, for the assignment to)13 3608 2 720 6232 t
10 B f
(current)4504 6232 w
10 R f
(vari-)4852 6232 w
(able.)720 6392 w
( the design of profilers: what to do with)8 1638(Functional programming languages introduce another problem for)6 2682 2 720 6712 t
( simplest choice is to do nothing; collect no call-counts and let the)12 2763( The)1 215( functions.)1 432(anonymous, first-class)1 910 4 720 6872 t
( charged to the caller of the unnamed function. The main disadvantage of this solution, besides not)16 4019(time be)1 301 2 720 7032 t
( is no convenient way to find the code that contributes to the cost of a)15 2882(having the call-counts, is that there)5 1438 2 720 7192 t
(profiled function that calls anonymous functions.)5 1965 1 720 7352 t
cleartomark
showpage
saveobj restore
%%EndPage: 3 3
%%Page: 4 4
/saveobj save def
mark
4 pagesetup
10 R f
(- 4 -)2 166 1 2797 480 t
( names for the unnamed functions \(for example, an)8 2205(Probably the most general solution is to make up)8 2115 2 720 880 t
( function)1 372(unnamed function statically enclosed in)4 1647 2 720 1040 t
10 I f
(f)2778 1040 w
10 R f
(might be called)2 644 1 2845 1040 t
10 I f
(f.anon)3528 1040 w
10 R f
( anonymous functions are)3 1071(\). If)1 188 2 3781 1040 t
( time will be reported.)4 901(given names they can be treated just as any other function; call counts and execution)14 3419 2 720 1200 t
( need to associate the new names with the correct function, but in practice this is)15 3346(Of course, the user will)4 974 2 720 1360 t
(rarely a problem.)2 684 1 720 1520 t
10 B f
( example)1 380(3. An)1 253 2 720 1840 t
10 R f
( ML function)2 557( The)1 217( example \(figure 1\).)3 828(To illustrate the technique, we present a simple)7 1963 4 720 2036 t
10 CW f
(subset)4357 2036 w
10 R f
(takes a)1 286 1 4754 2036 t
( an argument, and returns a function that maps lists to lists; the output list will be that)17 3479(predicate function as)2 841 2 720 2196 t
( input list containing just those elements that satisfy the predicate. The user's program is)14 3771(sublist of the)2 549 2 720 2356 t
( around it \(indicated in italics\) to make a)8 1684(displayed in typewriter font; the compiler puts some scaffolding)8 2636 2 720 2516 t
(record containing all the functions declared by the user.)8 2220 1 720 2676 t
10 I f
(let)1080 2896 w
10 CW f
(fun subset pred =)3 1020 1 1240 2896 t
(let fun f nil = nil)5 1140 1 1500 3056 t
(| f \(a::r\) = if pred a then a::f\(r\) else f\(r\))10 2700 1 1860 3216 t
(in f)1 240 1 1560 3376 t
(end)1500 3536 w
(fun isPrime x =)3 900 1 1260 3856 t
(let fun test i = i>=x orelse \(x mod i <> 0 andalso test\(i+1\)\))13 3660 1 1500 4016 t
(in test 2)2 540 1 1560 4176 t
(end)1500 4336 w
(val primes = subset isPrime)4 1620 1 1260 4656 t
10 I f
(in \(subset, isPrime, primes\))3 1102 1 1105 4816 t
(end)1080 4976 w
10 R f
(Figure 1.)1 361 1 2699 5256 t
( compiler inserts the call-counting and current-function)6 2249(If this code is compiled with profiling enabled, the)8 2071 2 720 5476 t
( as if written in the source)6 1109( we display the effects)4 944( Here,)1 281(instructions into the intermediate representation.)4 1986 4 720 5636 t
(language \(figure 2\).)2 789 1 720 5796 t
( entry to a func-)4 673( On)1 181( call-count and an interrupt-count.)4 1397( a)1 103( variables are introduced:)3 1038(For each function, two)3 928 6 720 6116 t
(tion, the call-count is incremented, and the global variable)8 2332 1 720 6276 t
10 B f
(current)3078 6276 w
10 R f
( On)1 173(is set to point to the interrupt-count.)6 1442 2 3425 6276 t
(re-entry to a function after a subroutine call,)7 1867 1 720 6436 t
10 B f
(current)2627 6436 w
10 R f
(is reset to the function's interrupt-count variable.)6 2051 1 2989 6436 t
(However, this is not necessary after recursive calls and tail calls, e.g. the calls to)14 3204 1 720 6596 t
10 CW f
(f)3984 6596 w
10 R f
(.)4044 6596 w
(The initial)1 415 1 720 6916 t
10 I f
(let)1161 6916 w
10 R f
( of just a record)4 634(-bindings create all the count variables, and the last four lines produce, instead)12 3145 2 1261 6916 t
( and a list of records)5 852( user's declared objects,)3 985( the)1 181(containing the user's declared objects, a pair of records:)8 2302 4 720 7076 t
( string constants will be)4 1026( These)1 307( variables, each with an identifying string constant.)7 2172(containing profiling)1 815 4 720 7236 t
cleartomark
showpage
saveobj restore
%%EndPage: 4 4
%%Page: 5 5
/saveobj save def
mark
5 pagesetup
10 R f
(- 5 -)2 166 1 2797 480 t
10 I f
(let val subset.CC = ref 0 and subset.IC = ref 0)10 1864 1 1080 940 t
(and subset.f.CC = ref 0 and subset.f.IC = ref 0)9 1873 1 1180 1100 t
(and isPrime.CC = ref 0 and isPrime.IC = ref 0)9 1889 1 1180 1260 t
(and isPrime.test.CC = ref 0 and isPrime.test.IC = ref 0)9 2217 1 1180 1420 t
10 CW f
(fun subset pred =)3 1020 1 1260 1740 t
10 I f
(\(subset.CC := !subset.CC + 1;)4 1236 1 1500 1900 t
(current := subset.IC;)2 853 1 1500 2060 t
10 CW f
(let fun f x =)4 780 1 1500 2220 t
10 I f
(\(subset.f.CC := !subset.f.CC + 1;)4 1342 1 1740 2380 t
(current := subset.f.IC;)2 906 1 1740 2540 t
10 CW f
(case x of)2 540 1 1740 2700 t
(nil => nil)2 600 1 1860 2860 t
(| a::r => let val pa = pred a)8 1740 1 1740 3020 t
(in)2400 3180 w
10 I f
(current := subset.f.IC;)2 906 1 2580 3180 t
10 CW f
(if pa then a :: f\(r\) else f\(r\))7 1800 1 2580 3340 t
(end)2340 3500 w
(in f)1 240 1 1560 3660 t
(end)1500 3820 w
(fun isPrime x =)3 900 1 1260 4140 t
10 I f
(\(isPrime.CC := !isPrime.CC + 1;)4 1358 1 2220 4140 t
(current := isPrime.IC;)2 914 1 2220 4300 t
10 CW f
(. . . \))3 420 1 2220 4460 t
(val primes = subset isPrime)4 1620 1 1260 4780 t
10 I f
(in \(\(subset, isPrime, primes\),)3 1160 1 1105 5100 t
(\(\(subset.CC, subset.IC, "subset"\),)2 1342 1 1205 5260 t
(\(subset.f.CC, subset.f.IC, "subset.f"\),)2 1468 1 1230 5420 t
(\(isPrime.test.CC, isPrime.test.IC, "isPrime.test"\),)2 1984 1 1230 5580 t
(\(isPrime.CC, isPrime.IC, "isPrime"\)\)\))2 1533 1 1230 5740 t
(end)1080 5900 w
10 R f
(Figure 2.)1 361 1 2699 6180 t
(embedded in the executable code for this module, and will enable the call-count variables to be self-)16 4320 1 720 6400 t
( is time to print)4 624( runtime system maintains a global list of these 3-element records; when it)12 3023(identifying. Our)1 673 3 720 6560 t
(an execution profile, they are sorted in decreasing order of interrupt-count.)10 2981 1 720 6720 t
cleartomark
showpage
saveobj restore
%%EndPage: 5 5
%%Page: 6 6
/saveobj save def
mark
6 pagesetup
10 R f
(- 6 -)2 166 1 2797 480 t
(Our output looks like the output of)6 1389 1 720 880 t
10 B f
(prof)2134 880 w
10 R f
(:)2317 880 w
10 CW f
( name)1 360( ms/call)1 480( #call)1 480(%time cumsecs)1 840 4 1080 1100 t
( isPrime.test)1 840( .045)1 480( 78189)1 480(90.4 3.52)1 780 4 1140 1260 t
( isPrime)1 540( 1000 .330)2 960(8.4 3.85)1 720 3 1200 1420 t
( \(unprofiled\))1 1320( 0)1 480(.7 3.88)1 660 3 1260 1580 t
( subset.f)1 600( 1001 .009)2 960(.2 3.89)1 660 3 1260 1740 t
( natlist)1 540( 1001 .000)2 960(.0 3.89)1 660 3 1260 1900 t
( subset)1 480( .000)1 480( 1)1 480(.0 3.89)1 660 4 1260 2060 t
10 R f
( a programmer might decide that it is worthwhile re-writing the)10 2820(Now, armed with this information,)4 1500 2 720 2440 t
10 CW f
(isPrime)720 2600 w
10 R f
( at a certain point the programmer will want to)9 1915( But)1 201( make it as efficient as possible.)6 1309(function to)1 443 4 1172 2600 t
(know what functions are calling)4 1305 1 720 2760 t
10 CW f
(isPrime)2091 2760 w
10 R f
( re-compiling with)2 758( By)1 174( often.)1 262(so he can make them call it less)7 1304 4 2542 2760 t
10 CW f
(isPrime)720 2920 w
10 R f
(unprofiled, any time spent in)4 1160 1 1167 2920 t
10 CW f
(isPrime)2389 2920 w
10 R f
( This)1 229( charged to the function that called it.)7 1499(will now be)2 476 3 2836 2920 t
(is because)1 415 1 720 3080 t
10 CW f
(isPrime)1203 3080 w
10 R f
(will not change the)3 787 1 1656 3080 t
10 B f
(current)2476 3080 w
10 R f
(variable, so that the timer-interrupt will increment the)7 2210 1 2830 3080 t
( last set)2 316(count for the function that)4 1079 2 720 3240 t
10 B f
(current)2148 3240 w
10 R f
(\320 and this will be the one that called)8 1557 1 2502 3240 t
10 B f
(isPrime)4092 3240 w
10 R f
( profiling)1 383(. The)1 238 2 4419 3240 t
( with)1 204(system won't do this automatically, but by comparing two different execution profiles, one)12 3635 2 720 3400 t
10 CW f
(isPrime)4620 3400 w
10 R f
(compiled with profile instructions and one with)6 1905 1 720 3560 t
10 CW f
(isPrime)2686 3560 w
10 R f
( can be made of)4 631(unprofiled, an accurate estimate)3 1277 2 3132 3560 t
(who is calling it.)3 667 1 720 3720 t
10 B f
( of our current-function method)4 1365(4. Advantages)1 625 2 720 4040 t
10 R f
( ordinary intermediate-representation operators for profiling, the optimizer and code-generator)9 3795(Since we use)2 525 2 720 4236 t
( an optimizer must not modify the)6 1481( Since)1 292( program.)1 408(``believe'' that profiling operations are part of the)7 2139 4 720 4396 t
( if one function)3 622( Therefore,)1 470( modified either.)2 669(semantics of the program, the semantics of profiling will not be)10 2559 4 720 4556 t
(is copied and inserted in-line into another, the call-count and current-function instructions will be copied)14 4320 1 720 4716 t
( optimizations that break functions into several disjoint pieces of code)10 2827( Other)1 280(and inserted at the right place.)5 1213 3 720 4876 t
(will leave the profiling instructions in the appropriate places.)8 2433 1 720 5036 t
( the implementation of the profiler is completely independent of the code gen-)12 3135(Furthermore, the result is that)4 1185 2 720 5356 t
( compiler \(two different algorithms each for the Vax)8 2119( have four different code generators for our)7 1752(erator. We)1 449 3 720 5516 t
(and the Motorola 68020\), and not a line of any of them was modified for the installation of the profiler.)19 4125 1 720 5676 t
( described in the previous section, we can find out what callers)11 2550(By compiling some functions unprofiled, as)5 1770 2 720 5996 t
( kind of trick serves much the same purpose that the)10 2130( This)1 233( of their execution time.)4 977(are responsible for most)3 980 4 720 6156 t
(more elaborate program)2 966 1 720 6316 t
10 B f
(gprof)1715 6316 w
10 R f
( histogram.)1 455(does; and it's a trick that wouldn't work with a program-counter)10 2608 2 1977 6316 t
( method is more accurate than)5 1285(Furthermore, our)1 700 2 720 6476 t
10 B f
(gprof)2747 6476 w
10 R f
( functions)1 414(. Suppose)1 431 2 2980 6476 t
10 I f
(f)3867 6476 w
10 R f
(and)3937 6476 w
10 I f
(g)4123 6476 w
10 R f
(both call a function)3 825 1 4215 6476 t
10 I f
(isPrime)720 6636 w
10 R f
(, but)1 181 1 1031 6636 t
10 I f
(f)1240 6636 w
10 R f
(consistently makes expensive calls \(that take a long time\) while)9 2571 1 1296 6636 t
10 I f
(g)3895 6636 w
10 R f
( ones.)1 237(makes cheap)1 515 2 3973 6636 t
10 B f
(Gprof)4779 6636 w
10 R f
(allocates the total time spent in)5 1251 1 720 6796 t
10 I f
(isPrime)1998 6796 w
10 R f
(on the basis of call counts from)6 1260 1 2336 6796 t
10 I f
(f)3622 6796 w
10 R f
(and)3676 6796 w
10 I f
(g)3846 6796 w
10 R f
(; this will miss the fact that)6 1090 1 3896 6796 t
10 I f
(f)5012 6796 w
10 R f
( this example, when profiling for)5 1320( In)1 134(is responsible for most of the cost.)6 1380 3 720 6956 t
10 I f
(isPrime)3580 6956 w
10 R f
( off,)1 168(is turned)1 348 2 3917 6956 t
10 I f
(f)4460 6956 w
10 R f
(and)4515 6956 w
10 I f
(g)4686 6956 w
10 R f
(will be)1 277 1 4763 6956 t
(charged for the actual time spent in)6 1438 1 720 7116 t
10 I f
(isPrime)2188 7116 w
10 R f
( the other hand,)3 636( \(On)1 210(on their behalf.)2 617 3 2529 7116 t
10 B f
(Gprof)4022 7116 w
10 R f
(will give an accu-)3 727 1 4313 7116 t
(rate breakdown of call-site counts that our method does not provide.\))10 2759 1 720 7276 t
cleartomark
showpage
saveobj restore
%%EndPage: 6 6
%%Page: 7 7
/saveobj save def
mark
7 pagesetup
10 R f
(- 7 -)2 166 1 2797 480 t
( an unprofiled function, then during the execution of the called function, all timer)13 3274(If a profiled function calls)4 1046 2 720 880 t
( to the caller \(since)4 811(interrupts will be charged)3 1065 2 720 1040 t
10 B f
(current)2634 1040 w
10 R f
( is often)2 348( This)1 241(still points to the caller's variable\).)5 1458 3 2993 1040 t
( if an unprofiled function calls a profiled function, then upon return to)12 2901( But)1 204(desirable, as described above.)3 1215 3 720 1200 t
(the unprofiled function the)3 1077 1 720 1360 t
10 B f
(current)1825 1360 w
10 R f
( will continue to be charged to the)7 1376(pointer won't be reset, and interrupts)5 1490 2 2174 1360 t
( a)1 81( In)1 145( is undesirable, and should be prevented by the compiler.)9 2376( This)1 239(called function after it has returned.)5 1479 5 720 1520 t
( functions, it is difficult to prevent profiled functions from being passed as argu-)13 3324(language with first-class)2 996 2 720 1680 t
( practice, this has not proved to be a problem,)9 1894( In)1 140(ments to unprofiled functions that might then call them.)8 2286 3 720 1840 t
( unprofiled functionals are typically simple primitives like)7 2392(probably because)1 705 2 720 2000 t
10 I f
(app)3851 2000 w
10 R f
(and)4035 2000 w
10 I f
(map)4213 2000 w
10 R f
(, which do little)3 655 1 4385 2000 t
(intrinsic computation.)1 878 1 720 2160 t
10 B f
( measurements)1 640(5. Overhead)1 547 2 720 2480 t
10 R f
( program several times with various of our profiling features enabled; this gives a reason-)14 3641(We ran the same)3 679 2 720 2676 t
(ably accurate measurement of profiling overhead:)5 1986 1 720 2836 t
10 S f
(_ ___________________________________________)1 2171 1 1794 2976 t
10 R f
(Time %Overhead)1 902 1 3013 3136 t
10 S f
(_ ___________________________________________)1 2171 1 1794 3196 t
10 R f
( sec)1 152( 2801)1 898(User code)1 401 3 1844 3356 t
10 S f
(_ ___________________________________________)1 2171 1 1794 3416 t
10 R f
( 20.3%)1 666( 568)1 846(Call counts)1 453 3 1844 3576 t
( 10.2)1 583( 286)1 350(Setting current function)2 949 3 1844 3736 t
( 1.7)1 583(Interrupts 47)1 1299 2 1844 3896 t
10 S f
(_ ___________________________________________)1 2171 1 1794 3956 t
10 R f
( 32.2%)1 666( 901)1 676(Total Overhead)1 623 3 1844 4116 t
10 S f
( \347)1 -2171(_ ___________________________________________)1 2171 2 1794 4176 t
(\347)1794 4076 w
(\347)1794 3976 w
(\347)1794 3876 w
(\347)1794 3776 w
(\347)1794 3676 w
(\347)1794 3576 w
(\347)1794 3476 w
(\347)1794 3376 w
(\347)1794 3276 w
(\347)1794 3176 w
(\347)1794 3076 w
(\347)3965 4176 w
(\347)3965 4076 w
(\347)3965 3976 w
(\347)3965 3876 w
(\347)3965 3776 w
(\347)3965 3676 w
(\347)3965 3576 w
(\347)3965 3476 w
(\347)3965 3376 w
(\347)3965 3276 w
(\347)3965 3176 w
(\347)3965 3076 w
10 R f
( instructions to)2 617( code generator takes three)4 1108( Our)1 215(The total overhead of 32% is not prohibitively expensive.)8 2380 4 720 4416 t
(increment a call-count \(fetch, add, store\); a better instruction-selector could probably reduce this overhead)13 4320 1 720 4576 t
(to 8%, and the total overhead to 20%.)7 1506 1 720 4736 t
(There is also an implementation overhead; it turned out to be fairly simple to get this profiler running.)17 4074 1 720 5056 t
( lines)1 214( 49)1 300(Insertion of profiling instructions)3 1330 3 1958 5296 t
( 32)1 906(Interrupt handling)1 724 2 1958 5456 t
( 16)1 990(Global database)1 640 2 1958 5616 t
( 72)1 912(Report generation)1 718 2 1958 5776 t
10 S f
(_ ____________________________________)1 1844 1 1958 5836 t
10 R f
( lines)1 214(Total 169)1 1630 2 1958 5996 t
(In contrast, this paper is about 500 lines long.)8 1821 1 720 6236 t
10 B f
(6. Conclusion)1 604 1 720 6556 t
10 R f
( into problems when we attempt to apply them to functional)10 2663(Traditional approaches to profiling run)4 1657 2 720 6752 t
( be moved around by garbage collection, and the task is further complicated)12 3198(languages where code may)3 1122 2 720 6912 t
( basic difficulty is that the mapping between)7 1815( The)1 211( freely rearranges the code.)4 1105(when an optimizing compiler)3 1189 4 720 7072 t
(the current pc and the currently executing function is difficult to maintain.)11 2962 1 720 7232 t
cleartomark
showpage
saveobj restore
%%EndPage: 7 7
%%Page: 8 8
/saveobj save def
mark
8 pagesetup
10 R f
(- 8 -)2 166 1 2797 480 t
( variable that)2 545(We have found a simple way around this difficulty, which consists of maintaining a global)14 3775 2 720 880 t
( the interrupt count for the current function, and which is to be charged whenever there is a)17 3664(always points to)2 656 2 720 1040 t
( manipulate this variable in the intermediate representation of the compiler, our)11 3189( we)1 142( Because)1 383(timer interrupt.)1 606 4 720 1200 t
( generation or garbage collection)4 1325(method is very easy to implement and has no nasty interactions with code)12 2995 2 720 1360 t
(algorithms \(which already preserve semantics of intermediate-representation operations\).)7 3558 1 720 1520 t
( by judiciously mixing profiled and)5 1524( Furthermore,)1 596(This method has acceptable overhead and accuracy.)6 2200 3 720 1840 t
(unprofiled functions, one can extract information on inherited costs as well as the direct costs of calling par-)17 4320 1 720 2000 t
( that provided by sophisticated profilers like gprof, but is)9 2366( information is similar to)4 1031( This)1 237(ticular functions.)1 686 4 720 2160 t
(more accurate.)1 586 1 720 2320 t
10 B f
(References)720 2640 w
10 R f
( Standard ML compiler,'' in)4 1137( ``A)1 190( Andrew W. and MacQueen, David B.)6 1538([Appel87] Appel,)1 989 4 720 2872 t
10 I f
(Functional)4601 2872 w
(Programming Languages and Computer Architecture)4 2169 1 1440 3032 t
10 R f
(, LNCS 274, G. Kahn, ed., pp 301-)7 1431 1 3609 3032 t
(324, 1987)1 400 1 1440 3192 t
( a call)2 250( ``gprof:)1 366( L. Graham, Peter B. Kessler, and Marshall K. McKusick.)9 2369( Susan)1 269([Graham82] Graham,)1 1066 5 720 3388 t
(graph execution profiler''" in)3 1180 1 1440 3548 t
10 I f
( Compiler Construction, SIG-)3 1192(Proc. SIGPLAN '82 Symp. on)4 1201 2 2647 3548 t
(PLAN Notices)1 570 1 1440 3708 t
10 R f
(17\(4\), pp. 120-126, 1982.)3 1024 1 2035 3708 t
( Y., and Johnson, R. H.,)5 1018( T.)1 122([Johnston70] Johnston,)1 1101 3 720 3904 t
10 I f
(Program Performance Measurement)2 1499 1 2998 3904 t
10 R f
(, SLAC User)2 543 1 4497 3904 t
(Note 33, Rev. 1, Stanford University, California, 1970.)7 2201 1 1440 4064 t
( command,'' section 1, Bell Laboratories, Murray)6 2126( Programmer's Manual, ``prof)3 1274([Unix] Unix)1 920 3 720 4260 t
(Hill, NJ, 1979.)2 592 1 1440 4420 t
cleartomark
showpage
saveobj restore
%%EndPage: 8 8
%%Trailer
done
%%Pages: 8
%%DocumentFonts: Times-Bold Times-Italic Courier Times-Roman Symbol
